<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <meta name="description" content="iSmartShop — онлайн-магазин iPhone, Samsung, MacBook и аксессуаров. Купить смартфон по выгодной цене с доставкой.">
  <title>iSmartShop — Магазин цифровой техники в Южно-Сахалинске</title>
  <link rel="stylesheet" href="styles.css" />
  <script>
    // Backend API base (deployed on Render)
    window.ISMART_API_BASE = 'https://ismartshopdatabase.onrender.com';
  </script>
  <script>
    // Early sanitizer to block suspicious image src values (runs before body parsing completes)
    (function(){
      try{
        const blockIfSuspicious = (src)=>{
          if(!src) return false;
          const s = String(src).trim();
          return s === '/po' || s === 'po' || s.endsWith('/po');
        };

        // Override HTMLImageElement.src setter to block JS assignments
        const desc = Object.getOwnPropertyDescriptor(HTMLImageElement.prototype, 'src');
        if(desc && desc.set){
          Object.defineProperty(HTMLImageElement.prototype, 'src', {
            set(v){ try{ if(blockIfSuspicious(v)){ console.warn('Blocked image.src assignment', v); return; } }catch(e){}
              return desc.set.call(this, v);
            },
            get(){ return desc.get.call(this); },
            configurable: true
          });
        }

        // MutationObserver to sanitize images inserted into DOM during parsing
        const observer = new MutationObserver((recs)=>{
          for(const rec of recs){
            for(const node of rec.addedNodes || []){
              if(node && node.tagName === 'IMG'){
                try{ const src = node.getAttribute('src') || node.getAttribute('data-src') || ''; if(blockIfSuspicious(src)){ node.removeAttribute('src'); node.dataset.blocked = src; console.warn('Removed suspicious img src at parse time', src); } }catch(e){}
              }
            }
            if(rec.type === 'attributes' && rec.target && rec.target.tagName === 'IMG'){
              try{ const src = rec.target.getAttribute('src') || ''; if(blockIfSuspicious(src)){ rec.target.removeAttribute('src'); rec.target.dataset.blocked = src; console.warn('Removed suspicious img src (attr change)', src); } }catch(e){}
            }
          }
        });
        observer.observe(document.documentElement, { childList: true, subtree: true, attributes: true, attributeFilter:['src'] });
      }catch(e){/* ignore */}
    })();
  </script>
</head>
<body class="loading">
  <!-- Loading overlay shown on first open. Hides after 3s. -->
  <div id="loader" class="loader" role="status" aria-label="Загрузка">
    <div class="loader-inner">
      <img src="assets/images/logo.png" alt="iSmartShop" class="loader-logo" />
    </div>
  </div>

  <div class="app">
    <header class="top">
      <div class="spacer"></div>
        <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme" title="Переключить тему">
          <!-- sun/moon icon (will be toggled via JS) -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3v2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 19v2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M4.22 4.22l1.42 1.42" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M18.36 18.36l1.42 1.42" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M1 12h2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 12h2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M4.22 19.78l1.42-1.42" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <div class="brand logo-placeholder" id="brand"><img src="assets/images/logo.png" alt="logo" width="50%" height="auto"></div>
    </header>

    <div class="search-row">
      <div class="search-wrap">
        <input class="search" placeholder="Поиск" id="search" />
      </div>
      <button class="voice" aria-label="search">
        <!-- right-side loupe icon -->
        <svg viewBox="0 0 24 24" class="icon loupe" aria-hidden="true"><path d="M21 21l-4.35-4.35" stroke="#111" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none"/><path d="M11 18a7 7 0 1 1 0-14 7 7 0 0 1 0 14z" stroke="#111" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>
      </button>
    </div>

    <main class="content" id="view-home" data-view>
      <section class="carousel-wrap">
        <button class="carousel-btn left" id="prev" aria-label="prev">
          <svg viewBox="0 0 24 24" class="icon arrow"><path d="M15 6l-6 6 6 6" stroke="#111" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>
        </button>
        <div class="carousel" id="carousel">
          <div class="slide"><img src="assets/images/iphone17pro.jpg" alt="slide" /></div>
          <div class="slide"><img src="assets/images/iphoneair.jpg" alt="slide" /></div>
          <div class="slide"><img src="assets/images/iphone17.jpg" alt="slide" /></div>
          <div class="slide"><img src="assets/images/airpods.jpg" alt="slide" /></div>
        </div>
        <button class="carousel-btn right" id="next" aria-label="next">
          <svg viewBox="0 0 24 24" class="icon arrow"><path d="M9 6l6 6-6 6" stroke="#111" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>
        </button>
        <div class="dots" id="dots"></div>
      </section>

        <!-- Categories: loaded from server (or fallback sample). Click to filter products -->
        <section class="categories-wrap">
          <div class="categories" id="categories">
            <!-- pills will be injected by script.js -->
          </div>
        </section>

      <section class="grid" id="products">
        <!-- product cards will be injected here by script.js -->
      </section>
      
    </main>

    <!-- Favorites view (placeholder) -->
    <main class="content" id="view-favorites" data-view style="display:none">
      <div class="favorites-header"><button class="favorites-pill">Избранные</button></div>
      <section class="grid" id="favorites">
        <!-- favorites will be injected here -->
      </section>
    </main>

    <!-- Chats view -->
    <main class="content" id="view-chats" data-view style="display:none">
      <section class="chats-wrap">
        <div class="chats-header">
          <button class="pill big">Чаты</button>
        </div>
        <div class="chats-panel" id="chats-panel">
          <div class="chat-list" id="chat-list">
            <!-- list of chats will be injected here -->
          </div>
        </div>

        <!-- chat overlay (separate window) - moved out to be a direct child of .app -->
      </section>
    </main>
    </main>

    <main class="content" id="view-product" data-view style="display:none">
      <section class="product-wrap">
        <div class="product-card">
          <button id="product-close" class="icon-btn" aria-label="back">‹</button>
          <div class="product-image"><img id="product-img" src="" alt="product" /></div>
          <div class="product-body">
            <div class="product-price" id="product-price"></div>
            <div class="product-title" id="product-title"></div>
            <div class="product-desc" id="product-desc"></div>
            <div class="product-colors" id="product-colors"></div>
            <div class="product-actions">
              <button id="product-fav" class="fav-pill">В избранные</button>
              <button id="product-buy" class="buy-pill">Купить</button>
            </div>
          </div>
        </div>
      </section>
    </main>

    <nav class="tabbar">
      <button class="tab" data-tab="view-favorites" aria-label="Избранные">
        <svg viewBox="0 0 24 24" class="icon tab-icon" aria-hidden="true"><path d="M12 21s-7-4.6-9-7.2C1 10.2 3.2 6 7 6c2 0 3.5 1.3 5 3 1.5-1.7 3-3 5-3 3.8 0 6 4.2 4 7.8-2 2.6-9 7.2-9 7.2z"/></svg>
        <span>Избранные</span>
      </button>
      <button class="tab active" data-tab="view-home" aria-label="Главная">
        <svg viewBox="0 0 24 24" class="icon tab-icon" aria-hidden="true"><path d="M3 7h18v13H3z"/><path d="M3 7l9-4 9 4"/></svg>
        <span>Главная</span>
      </button>
      <button class="tab" data-tab="view-chats" aria-label="Чаты">
        <svg viewBox="0 0 24 24" class="icon tab-icon" aria-hidden="true"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        <span>Чаты</span>
      </button>
    </nav>
    <!-- chat overlay (separate window) - direct child of .app so it stays visible when others are hidden -->
    <div class="chat-view" id="chat-view" style="display:none">
      <div class="chat-top">
        <button id="chat-back" class="circle-back">‹</button>
        <div class="chat-title-pill" id="chat-title">Чат</div>
        <button id="chat-delete" class="del-pill" title="Удалить чат">Удалить чат</button>
      </div>
      <div class="messages" id="messages"></div>
      <div class="composer">
        <input id="message-input" placeholder="Введите сообщение" />
        <button id="send-message" class="send-circle">➤</button>
      </div>
    </div>
  </div>

  <script src="script.js"></script>

  <!-- Cookie access banner / check -->
  <div id="cookie-banner" style="position:fixed;left:12px;right:12px;top:12px;z-index:99999;padding:12px;background:rgba(255,255,255,0.98);border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.12);display:none">
    <div style="display:flex;align-items:center;gap:12px;">
      <div style="flex:1">Для корректной работы входа и регистрации требуется поддержка Cookies. Нажмите «Проверить», чтобы выполнить тест. Если тест не проходит — откройте настройки браузера и разрешите cookies (включая third‑party cookies) и используйте HTTPS.</div>
      <div style="display:flex;gap:8px"><button id="cookie-test-btn" style="padding:8px 12px;border-radius:8px;border:0;cursor:pointer">Проверить</button><button id="cookie-dismiss" style="padding:8px 12px;border-radius:8px;border:0;cursor:pointer;background:#eee">Закрыть</button></div>
    </div>
  </div>
  <!-- Footer -->
  <footer class="site-footer" role="contentinfo">
    <div class="site-footer-inner">
      <div class="footer-left">
        <div class="footer-brand">iSmartShop</div>
        <div class="footer-copy">© <span id="year">2025</span> iSmartShop — Все права защищены.</div>
      </div>
      <div class="footer-right">
        <a href="/contacts" class="footer-link">Контакты</a>
        <a href="/terms" class="footer-link">Условия</a>
        <a href="/privacy" class="footer-link">Политика конфиденциальности</a>
      </div>
    </div>
  </footer>

  <script>
    (function(){
      const banner = document.getElementById('cookie-banner');
      const btn = document.getElementById('cookie-test-btn');
      const dismiss = document.getElementById('cookie-dismiss');
      function testCookies(){
        try{
          // try to set a test cookie readable by JS
          document.cookie = 'ismart_test=1; path=/';
          const ok = document.cookie.indexOf('ismart_test=1') !== -1;
          if(ok){ document.cookie = 'ismart_test=; Max-Age=0; path=/'; window.ISMART_COOKIES_OK = true; banner.style.display='none'; }
          else { window.ISMART_COOKIES_OK = false; banner.style.display=''; }
          return ok;
        }catch(e){ window.ISMART_COOKIES_OK = false; banner.style.display=''; return false; }
      }
      btn?.addEventListener('click', ()=>{ const ok = testCookies(); if(ok) alert('Cookies доступны.'); else alert('Cookies недоступны. Проверьте настройки браузера и HTTPS.'); });
      dismiss?.addEventListener('click', ()=> banner.style.display='none');
      setTimeout(testCookies, 50);
    })();
  </script>

  <!-- Auth modal (login / registration) -->
  <div class="auth-modal" id="auth-modal" aria-hidden="true" style="display:none">
    <div class="auth-card">
      <div class="auth-top">
        <div class="auth-note">Зарегистрируйтесь или войдите в свой аккаунт чтобы пользоваться сайтом</div>
      </div>
      <div class="auth-tabs">
        <button id="tab-login" class="auth-tab">Войти</button>
        <button id="tab-register" class="auth-tab">Регистрация</button>
      </div>
      <div class="auth-forms">
        <form id="form-login" class="auth-form" style="display:none" onsubmit="return false">
          <h2>Войти</h2>
          <input id="login-email" placeholder="Адрес электронной почты" type="email" />
          <input id="login-password" placeholder="Пароль" type="password" />
          <button id="login-submit" class="primary-cta" type="button">Войти</button>
        </form>
        <form id="form-register" class="auth-form" style="display:none" onsubmit="return false">
          <h2>Регистрация</h2>
          <input id="reg-name" placeholder="Имя" type="text" />
          <input id="reg-email" placeholder="Адрес электронной почты" type="email" />
          <input id="reg-password" placeholder="Пароль" type="password" />
          <input id="reg-password-repeat" placeholder="Повторите пароль" type="password" />
          <button id="reg-submit" class="primary-cta" type="button">Зарегистрироваться</button>
        </form>
      </div>
    </div>
  </div>
  <!-- Verification modal -->
  <div class="verify-modal" id="verify-modal" aria-hidden="true" style="display:none">
    <div class="auth-card">
      <div class="auth-top">
        <div class="auth-note">Введите код подтверждения из письма</div>
      </div>
      <form id="form-verify" class="auth-form" onsubmit="return false">
        <input id="verify-email" type="email" placeholder="Email" style="margin-bottom:8px" />
        <input id="verify-code" type="text" placeholder="Код из письма" />
        <div style="display:flex;gap:8px;margin-top:8px;">
          <button id="verify-submit" class="primary-cta" type="button">Подтвердить</button>
          <button id="verify-resend" class="secondary-cta" type="button">Отправить код ещё раз</button>
        </div>
      </form>
    </div>
  </div>
</body>
</html>
